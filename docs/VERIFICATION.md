# Проверка состояния проекта

Краткий отчёт: что сделано, соответствие [DEVELOPMENT.md](../DEVELOPMENT.md), что дальше.

---

## Обновление контейнеров

После изменений в коде пересоберите образы и перезапустите стек:

```bash
docker compose build --no-cache
docker compose up -d
```

Миграции БД (Flyway V1–V18) применяются при старте контейнера **app**. В т.ч. V12 — явка на матч (event_attendance), V18 — события интеграции (integration_event) для метрик доставки сообщений.

---

## Сделано

### Инфраструктура

| Компонент | Статус |
|-----------|--------|
| Spring Boot 3.2, Java 17 | OK |
| PostgreSQL, Flyway (V1 — teams, players, matches) | OK |
| Telegram Bot (long polling), конфиг из env | OK |
| Dockerfile, docker-compose (postgres + app), docker-compose.dev | OK |
| .cursor/rules/development-standards.mdc, DEVELOPMENT.md | OK |

### Фаза 1 — MVP Core

| Требование | Реализация |
|------------|------------|
| Фильтрация по team_id | Все сервисы работают с teamId; репозитории — findByTeamId*, setResult проверяет принадлежность матча команде |
| Транзакции, getReferenceById | @Transactional в сервисах; Team — через teamRepository.getReferenceById(teamId) |
| Ввод пользователя | trim(), проверка пустоты/числа, сообщения об ошибках в чат |
| /start → создание команды | pendingTeamName (in-memory), при следующем сообщении — создание Team, telegramChatId = chatId |
| Меню (кнопки) в боте | Расписание, Состав, Мой профиль, Выйти из команды, Опрос на игру. Управление (игроки, матчи, результаты, долги, приглашения) — в веб-админке. |
| /schedule, /roster, /profile, /leave, /poll | Реализованы в боте; добавление игроков, матчи, результат, долги — в админке. |

### Соответствие установкам разработки

- **Фильтрация по команде:** да, везде teamId.
- **Транзакции и ссылки:** да.
- **Ввод и ошибки:** валидация, ответы пользователю.
- **Сценарии:** нет команды → подсказка; пустой состав / нет матча → сообщения.
- **Секреты:** токен и БД из конфига/env.

---

## Граничные случаи (проверено)

- Нет команды → «Сначала создай команду…».
- Пустое название команды → «Название не может быть пустым».
- Добавить игрока без имени/номера → подсказка формата; пустое имя → исключение с сообщением.
- Результат без запланированного матча → «Нет запланированного матча».
- Результат: не два числа → подсказка формата.

---

## Где смотреть доработки (Участники, Приглашения, Настройки, бот)

### Админка (http://localhost:3000)

1. Убедитесь, что бэкенд доступен для admin-ui: `docker compose restart admin-ui`, затем обновите страницу.
2. Войдите: логин **admin**, пароль из переменной `ADMIN_PASSWORD` или по умолчанию **admin**.
3. **Если команд ещё нет** — отображается экран **«Первоначальная настройка»**: поле **Telegram администратора (@username)** и кнопка «Сохранить». После сохранения этот пользователь может в боте отправить /start и создать первую команду. Обновите страницу после создания команды в боте.
4. В шапке после выбора команды: **Дашборд**, **Матчи**, **Долги**, **Участники**, **Приглашения**, **Настройки** (и **Состав** в меню).
5. **Участники** — таблица: **Имя** (редактируемое), **Контакт** (@username), **Роль** (Игрок/Админ), смена роли.
6. **Приглашения** — создание приглашений (роль Игрок или Админ, срок), ссылка и QR; новый участник в боте вводит **/start CODE**.
7. **Настройки** — «Доступ в бот»: **@username** (кто может создать команду в боте без приглашения); канал для публикации.

Если видите только «Загрузка…» или пустые страницы — запросы к API не доходят. Проверьте: `docker compose logs admin-ui --tail 20`.

### Бот (Telegram)

1. Убедитесь, что запущен актуальный образ: `docker compose build app --no-cache && docker compose up -d`.
2. В боте меню кнопок: **Расписание**, **Состав**, **Мой профиль**, **Выйти из команды**, **Опрос на игру**. Команды: /start, /schedule, /roster, /profile, /leave, /poll. Приглашения создаются в админке; в боте только вход по **/start CODE**.
3. Создание команды: только если ваш @username указан в админке (Настройки → Доступ в бот). Иначе бот просит получить приглашение.

---

## Проверка работы бота (пошагово)

**Полный чек-лист smoke-тестов всех сценариев в Telegram:** [SMOKE_TESTS_TELEGRAM.md](SMOKE_TESTS_TELEGRAM.md).

Убедитесь, что контейнер **app** запущен и в `.env` заданы `TELEGRAM_BOT_TOKEN` и при необходимости `TELEGRAM_BOT_USERNAME`. Логи: `docker compose logs app --tail 30`.

### 1. Меню и команды бота

| Действие | Ожидаемый результат |
|----------|---------------------|
| Открыть меню кнопок (слева от поля ввода) | Кнопки: **Расписание**, **Состав**, **Мой профиль**, **Выйти из команды**, **Опрос на игру**. |
| Написать **/schedule**, **/roster**, **/profile**, **/leave**, **/poll** | Расписание матчей, состав команды, запрос имени для профиля, подтверждение выхода, опрос в чат. Приглашения создаются в админке, в боте только вход по коду. |

### 2. Первый запуск: создание команды (@username в админке)

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 2.1 | В админке при отсутствии команд: **Первоначальная настройка** → вписать свой **@username** → Сохранить. Либо **Настройки** → «Доступ в бот» → **@username** → Сохранить. | «Сохранено. Теперь этот пользователь может в Telegram…» или «Сохранено». |
| 2.2 | В боте от этого аккаунта написать **/start** (без кода). | «Привет! Отправь название команды одним сообщением.» |
| 2.3 | Отправить название, например **Тестовая команда**. | «Команда «Тестовая команда» создана. Участники видят расписание, состав… Админка — для управления.» + меню кнопок. |
| 2.4 | Другой аккаунт (его @username не в настройках) пишет **/start** без кода. | «Создать команду может только администратор. Попросите ссылку-приглашение у менеджера команды.» |

### 3. Проверка приглашений

Одно приглашение действует для **нескольких человек** (по одной ссылке могут перейти много раз, приглашение не сгорает). Срок действия — до указанной при создании даты.

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 3.1 | В админке войти, выбрать команду → **Приглашения**. Нажать «Создать приглашение», выбрать роль (Игрок/Админ) и срок (дней). | В списке появляется приглашение: **код**, **ссылка** (t.me/BotUsername?start=КОД), **QR-код**, дата окончания. Кнопка «Копировать ссылку». |
| 3.2 | Скопировать ссылку или отправить другому человеку. Он открывает ссылку в Telegram (или в боте вводит **/start КОД**). | Бот отвечает: «Вы добавлены в команду «…». Роль: … Дальше: откройте чат команды в Telegram и напишите там /start…» В админке **Участники** появляется новый участник с выбранной ролью и @username (если есть). |
| 3.3 | Тот же код использовать с **другого** аккаунта Telegram. | То же сообщение об успешном добавлении; в Участниках — ещё один человек. Одно приглашение = массовое добавление. |
| 3.4 | Ввести **/start несуществующий_код** или код после истечения срока. | «Приглашение недействительно или уже использовано.» |
| 3.5 | В админке нажать «Удалить» у приглашения. | Приглашение исчезает из списка; по этой ссылке больше нельзя войти. |

### 4. Роли

| Действие | Ожидаемый результат |
|----------|---------------------|
| В боте | Все участники видят одно меню (Расписание, Состав, Мой профиль, Выйти, Опрос). Роли Игрок/Админ влияют на доступ в админке и уведомления. |
| В админке **Участники** | Имя (редактируемое), контакт @username, роли **Игрок** / **Админ**; смена роли через выпадающий список. |

Если бот не отвечает — проверьте логи (`docker compose logs app --tail 50`) и наличие токена в `.env`.

---

## Чек-лист регрессии после изменений

Проводить после правок в приглашениях, выборе команды, участниках и дашборде.

| № | Действие | Ожидаемый результат |
|---|----------|---------------------|
| 1 | Войти в админку (логин и пароль). | Успешный вход, при отсутствии команды — экран выбора или первоначальная настройка. |
| 2 | Выбрать команду или сменить команду (если их несколько). | В шапке отображается выбранная команда, доступны разделы Дашборд, Матчи, Участники, Приглашения, Настройки. |
| 3 | Открыть **Дашборд**, затем **Участники**. | Число «Участников в команде» на дашборде совпадает с количеством строк в таблице на странице Участники. |
| 4 | **Приглашения** → «Создать приглашение» (роль, срок) → создать. | В списке появляется приглашение с кодом, ссылкой и QR. |
| 5 | Открыть ссылку приглашения в другом аккаунте Telegram (или ввести **/start КОД**). | Бот отвечает об успешном добавлении в команду и подсказкой про /start в чате команды. |
| 6 | В админке открыть **Участники**. | В списке появился новый участник с выбранной ролью (и @username при наличии). |

---

## Дальше по плану

- **Фаза 2:** шаблоны текста после матча (сделано: MatchPostService, пост в чат после /result) → генерация картинок → отправка в Telegram.
- **Фаза 3:** опросы, финансы, статусы игроков, напоминания.
- **Фаза 4:** мультитенантность, оплата, админка.

Обновлено: по состоянию на текущую дату (см. ROADMAP.md).
