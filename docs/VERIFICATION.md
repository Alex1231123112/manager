# Проверка состояния проекта

Краткий отчёт: что сделано, соответствие [DEVELOPMENT.md](../DEVELOPMENT.md), что дальше.

---

## Обновление контейнеров

После изменений в коде пересоберите образы и перезапустите стек:

```bash
docker compose build --no-cache
docker compose up -d
```

Миграции БД (Flyway V1–V8) применяются при старте контейнера **app**. V8 добавляет в `team_members` поля `telegram_username`, `display_name` и настройку `admin_telegram_username`.

---

## Сделано

### Инфраструктура

| Компонент | Статус |
|-----------|--------|
| Spring Boot 3.2, Java 17 | OK |
| PostgreSQL, Flyway (V1 — teams, players, matches) | OK |
| Telegram Bot (long polling), конфиг из env | OK |
| Dockerfile, docker-compose (postgres + app), docker-compose.dev | OK |
| .cursor/rules/development-standards.mdc, DEVELOPMENT.md | OK |

### Фаза 1 — MVP Core

| Требование | Реализация |
|------------|------------|
| Фильтрация по team_id | Все сервисы работают с teamId; репозитории — findByTeamId*, setResult проверяет принадлежность матча команде |
| Транзакции, getReferenceById | @Transactional в сервисах; Team — через teamRepository.getReferenceById(teamId) |
| Ввод пользователя | trim(), проверка пустоты/числа, сообщения об ошибках в чат |
| /start → создание команды | pendingTeamName (in-memory), при следующем сообщении — создание Team, telegramChatId = chatId |
| Меню (кнопки) | ReplyKeyboardMarkup: Состав, Добавить игрока, Новый матч, Ввести результат |
| /addplayer, /roster, /newmatch, /result | Реализованы; валидация имени и номера в addPlayer |

### Соответствие установкам разработки

- **Фильтрация по команде:** да, везде teamId.
- **Транзакции и ссылки:** да.
- **Ввод и ошибки:** валидация, ответы пользователю.
- **Сценарии:** нет команды → подсказка; пустой состав / нет матча → сообщения.
- **Секреты:** токен и БД из конфига/env.

---

## Граничные случаи (проверено)

- Нет команды → «Сначала создай команду…».
- Пустое название команды → «Название не может быть пустым».
- Добавить игрока без имени/номера → подсказка формата; пустое имя → исключение с сообщением.
- Результат без запланированного матча → «Нет запланированного матча».
- Результат: не два числа → подсказка формата.

---

## Где смотреть доработки (Участники, Приглашения, Настройки, бот /invite)

### Админка (http://localhost:3000)

1. Убедитесь, что бэкенд доступен для admin-ui: `docker compose restart admin-ui`, затем обновите страницу.
2. Войдите: логин **admin**, пароль из переменной `ADMIN_PASSWORD` или по умолчанию **admin**.
3. В шапке после входа должны быть ссылки: **Дашборд**, **Состав**, **Матчи**, **Долги**, **Участники**, **Приглашения**, **Настройки**.
4. **Участники** — таблица: **Имя** (редактируемое по клику), **Контакт** (в формате @username из Telegram), **Роль**, смена роли. Telegram ID не отображается; @username подставляется при взаимодействии пользователя с ботом.
5. **Приглашения** — создание приглашений с ролью и сроком, ссылка и QR-код; новый участник переходит по ссылке или вводит в боте `/start CODE`.
6. **Настройки** — блок «Доступ в бот»: поле **Telegram администратора** в формате **@username** (только этот пользователь может создавать новую команду в боте без приглашения). Блок «Команда» — ID канала для публикации результатов.

Если видите только «Загрузка…» или пустые страницы — запросы к API не доходят (например ECONNREFUSED). Выполните `docker compose restart admin-ui` и проверьте логи: `docker compose logs admin-ui --tail 20`.

### Бот (Telegram)

1. Убедитесь, что запущен актуальный образ: `docker compose build app --no-cache && docker compose up -d`.
2. В боте: отправьте **/commands** — в списке должна быть команда **«Создать приглашение в команду (капитан и выше)»** для **/invite**.
3. Внизу в меню кнопок должна быть кнопка **«Приглашение»** (для капитана и выше).
4. Приглашение: **/invite** или **/invite PLAYER** (роль) — бот пришлёт ссылку и картинку QR. Новый участник: переходит по ссылке или вводит **/start CODE** в боте.

Если в Telegram по-прежнему старое меню команд — закройте и снова откройте чат с ботом или отправьте /start (меню команд обновляется при регистрации бота на сервере).

---

## Проверка работы бота (пошагово)

Убедитесь, что контейнер **app** запущен и в `.env` заданы `TELEGRAM_BOT_TOKEN` и при необходимости `TELEGRAM_BOT_USERNAME`. Логи: `docker compose logs app --tail 30`.

### 1. Меню и команды

| Действие | Ожидаемый результат |
|----------|---------------------|
| Написать боту **/commands** | Список команд, среди них **/invite** — «Создать приглашение в команду (капитан и выше)». |
| Открыть меню кнопок (слева от поля ввода) | Внизу есть кнопка **«Приглашение»** (если вы уже в чате команды и ваша роль — капитан или админ). |

### 2. Создание команды без приглашения (@username)

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 2.1 | В админке **Настройки** → блок «Доступ в бот» → вписать свой Telegram в формате **@username** → Сохранить. | Сообщение «Сохранено». |
| 2.2 | В боте от имени этого аккаунта написать **/start** (без кода, без привязки к команде). | «Привет! Отправь название команды одним сообщением.» |
| 2.3 | Отправить название, например **Тестовая команда**. | «Команда «Тестовая команда» создана. Добавляй игроков и матчи.» + меню кнопок. |
| 2.4 | Другой аккаунт (его @username не указан в настройках) пишет **/start** без кода. | «Создать команду может только администратор. Попросите ссылку-приглашение у менеджера команды.» |

### 3. Приглашение и вход по коду

| Шаг | Действие | Ожидаемый результат |
|-----|----------|---------------------|
| 3.1 | В чате команды (капитан/админ) написать **/invite** или нажать кнопку **Приглашение**. | Бот присылает картинку (QR) и текст со ссылкой вида `t.me/BotUsername?start=КОД`. |
| 3.2 | Опционально: **/invite PLAYER** или **/invite CAPTAIN**. | То же, но при использовании ссылки новый участник получит указанную роль. |
| 3.3 | Новый пользователь переходит по ссылке из приглашения или в боте вводит **/start КОД** (подставить код из ссылки). | «Вы добавлены в команду «…». Роль: … Если бот в чате команды, напиши там /start.» |
| 3.4 | Тот же **/start КОД** отправить повторно или неверный код. | «Приглашение недействительно или уже использовано.» |

### 4. Роли в боте

| Действие | Ожидаемый результат |
|----------|---------------------|
| Админ пишет **/setrole 123456789 CAPTAIN** (подставить реальный Telegram ID участника). | «Роль назначена: 123456789 — CAPTAIN». |
| Не админ пишет **/setrole …** | Сообщение об ошибке (нет прав). |
| Игрок (роль PLAYER) открывает меню кнопок | Видны только: Состав, Опрос, Долги, Команды (без «Добавить игрока», «Новый матч», «Ввести результат», «Приглашение»). |
| Капитан/админ открывает меню | Все кнопки, включая Приглашение и ввод результата. |
| В админке **Участники** | Имя (редактируемое), контакт @username, роли; смена роли через интерфейс. |

Если бот не отвечает — проверьте логи (`docker compose logs app --tail 50`) и наличие токена в `.env`.

---

## Дальше по плану

- **Фаза 2:** шаблоны текста после матча (сделано: MatchPostService, пост в чат после /result) → генерация картинок → отправка в Telegram.
- **Фаза 3:** опросы, финансы, статусы игроков, напоминания.
- **Фаза 4:** мультитенантность, оплата, админка.

Обновлено: по состоянию на текущую дату (см. ROADMAP.md).
