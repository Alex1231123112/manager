# Smoke-тесты: сценарии бота в Telegram

Чек-лист для ручной проверки всех сценариев бота. Прогонять после изменений в боте или при приёке релиза. Контейнер **app** должен быть запущен, в `.env` заданы `TELEGRAM_BOT_TOKEN` и при необходимости `TELEGRAM_BOT_USERNAME`.

**Как проверять:** выполнить шаги в колонке «Действие», сверить с «Ожидаемый результат», отметить ✅ / ❌.

---

## Подготовка

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| P0 | `docker compose ps` — контейнер **basketbot-app** в статусе Up | Контейнер запущен | |
| P1 | В админке (localhost:3000) войти, при отсутствии команд указать свой **@username** в «Доступ в бот» и сохранить | Сохранено, можно создавать команду в боте | |

---

## 1. Создание команды и первый вход

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 1.1 | В боте от аккаунта с @username из настроек отправить **/start** (без кода) | «Привет! Отправь название команды одним сообщением. Например: БК Метеор» | |
| 1.2 | Отправить название команды (например **Тестовая команда**) | «Команда «Тестовая команда» создана…» + меню кнопок (Расписание, Состав, Мой профиль, Выйти из команды, Опрос на игру) | |
| 1.3 | От другого аккаунта (его @username не в настройках) отправить **/start** без кода | «Создать команду может только администратор. Попросите ссылку-приглашение у менеджера команды.» | |
| 1.4 | В чате, где команда уже создана, отправить **/start** | «Привет! Команда: «…». Расписание, состав, имя (Мой профиль)…» + меню кнопок | |
| 1.5 | При ожидании названия команды отправить пустое сообщение или пробелы | «Название не может быть пустым. Отправь название команды.» | |

---

## 2. Приглашения

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 2.1 | В админке: Приглашения → создать приглашение (роль Игрок или Админ, срок в днях) | В списке появилась ссылка и QR-код | |
| 2.2 | От **нового** аккаунта Telegram открыть ссылку приглашения (или в боте ввести **/start КОД**) | «Вы добавлены в команду «…». Роль: …» + подсказка про /start в чате команды | |
| 2.3 | В админке открыть Участники | В списке появился новый участник с выбранной ролью и @username (если есть) | |
| 2.4 | От того же или другого аккаунта ввести **/start несуществующий_код** | «Приглашение недействительно или уже использовано.» | |
| 2.5 | Создать приглашение, дождаться истечения срока (или удалить в админке), ввести **/start КОД** | «Приглашение недействительно или уже использовано.» | |

---

## 3. Расписание и прошедшие игры

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 3.1 | Нажать **Расписание** (или **/schedule**) | Только будущие игры (ближайшие первые) или «Ближайших игр нет. Расписание добавят в админке.» | |
| 3.2 | Нажать **Прошедшие игры** | Только прошедшие игры (последние первые) или «Прошедших игр пока нет.» | |
| 3.3 | В админке добавить матч на будущее, в боте **Расписание** | В списке отображается добавленный матч | |

---

## 4. Состав команды

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 4.1 | Нажать кнопку **Состав** (или **/roster**) | Список участников (имя, номер, статус) или «Состав пуст. Участников добавляют через приглашения и админку.» | |
| 4.2 | После добавления участников по приглашению снова **Состав** | В списке отображаются участники команды | |

---

## 5. Мой профиль (только просмотр)

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 5.1 | Нажать **Мой профиль** (или **/profile**) | Бот показывает профиль: Имя, Номер, Долг; подсказка «Редактирование имени, номера и долга — в админке (Участники)». Редактировать в боте нельзя | |

---

## 6. Выход из команды

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 6.1 | Нажать **Выйти из команды** (или **/leave**) | Бот просит подтвердить выход (повторно нажать или подтвердить) | |
| 6.2 | Подтвердить выход | «Вы вышли из команды. Чтобы снова вступить, нужна новая ссылка-приглашение от админа.» | |
| 6.3 | После выхода отправить **/start** без кода (если пользователь не в «Доступ в бот») | Сообщение про приглашение или просьба создать команду | |

---

## 6.4 Деактивированный участник

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 6.4.1 | В админке деактивировать участника (Участники → Активен: Нет) | Сохранено | |
| 6.4.2 | От этого аккаунта в боте отправить **/start** или нажать **Расписание** / **Мой профиль** / любой текст | «Вы деактивированы. Обратитесь к администратору команды.» (меню не показывается) | |

---

## 7. Опрос на игру (по шагам, без команды в чате)

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 7.1 | Нажать **Опрос на игру** (или **/poll**) | Бот: «Напиши вопрос для опроса одним сообщением. Например: Кто едет на игру?» | |
| 7.2 | Отправить вопрос текстом, например **Кто едет в субботу?** | Бот: «Напиши варианты ответа через запятую. Например: Еду, Не еду, Опоздаю» | |
| 7.3 | Отправить варианты, например **Еду, Не еду, Опоздаю** | В чат отправляется опрос с введённым вопросом и вариантами; бот: «Опрос отправлен в чат.» | |

---

## 8. Неизвестная команда и подсказки

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 8.1 | Отправить произвольный текст (не команда и не кнопка) | Подсказка про кнопки меню, опрос — кнопка «Опрос на игру» | |
| 8.2 | В личном чате без привязки к команде (после /start без кода, но не отправив название) отправить любой текст | «Сначала создай команду: отправь /start и затем название команды.» или про приглашение | |

---

## 9. Уведомление от админа

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 9.1 | В админке: Дашборд → ввести текст в «Уведомление команде» → Отправить в чат команды | В групповой чат команды в Telegram приходит сообщение с введённым текстом | |

---

## 10. Регрессия: админка и бот согласованы

| # | Действие | Ожидаемый результат | ✅/❌ |
|---|----------|---------------------|-------|
| 10.1 | В админке: число «Участников в команде» на Дашборде | Совпадает с количеством записей на странице Участники | |
| 10.2 | В админке сменить команду (если их несколько), проверить Дашборд и Участники | Данные соответствуют выбранной команде | |

---

## Итог

После прохода отметить общий результат: **все сценарии пройдены** / **есть падения** (указать номера тестов).

---

## Автотесты (соответствие сценариям)

Часть сценариев покрыта автоматическими тестами.

**Запуск:** локально `mvn test` или в контейнере (без поднятия Postgres):  
`docker compose run --rm tests`  
Отдельные классы: `docker compose run --rm tests mvn test -Dtest=InvitationServiceTest,SystemSettingsServiceTest,AdminApiInvitationsTest,AdminApiSystemSettingsTest,AdminApiLoginTest -B`

| Smoke | Сценарий | Автотест |
|-------|----------|----------|
| P1, 1.1, 1.3 | Доступ в бот (@username), кто может создавать команду | `SystemSettingsServiceTest`: `canCreateTeamWithoutInvite_*`, `getAndSetAdminTelegramUsername_*` |
| 2.1 | Создание приглашения (роль, срок) | `AdminApiInvitationsTest`: `createInvitation_*`, `createInvitation_thenList_*` |
| 2.2 | Использование приглашения по коду, добавление в команду | `InvitationServiceTest`: `use_validCode_addsMemberAndReturnsTeamNameAndRole`, `use_sameCodeTwice_*` |
| 2.4 | Неверный код приглашения | `InvitationServiceTest`: `use_nonexistentCode_returnsEmpty` |
| 2.5 | Истёкшее приглашение | `InvitationServiceTest`: `findByCode_expired_returnsEmpty`, `use_expiredCode_returnsEmpty` |
| — | Список приглашений, удаление | `AdminApiInvitationsTest`: `deleteInvitation_*`; `InvitationServiceTest`: `findByTeamId_*`, `deleteByCode_*` |

Ручной прогон smoke по-прежнему нужен для проверки UI бота (тексты сообщений, кнопки, групповой чат, опросы) и админки (логин в браузере, дашборд, участники).

Связанные документы: [BOT_SCENARIOS.md](BOT_SCENARIOS.md), [VERIFICATION.md](VERIFICATION.md).
