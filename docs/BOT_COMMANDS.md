# Команды бота: справочник

Все команды и кнопки бота и как они работают на текущей реализации. Один чат = одна команда: бот определяет команду по `telegram_chat_id` чата (личный или групповой).

---

## Регистрация команд в Telegram

В меню бота (кнопка «Меню» рядом с полем ввода) отображаются команды; те же действия доступны по кнопкам под полем ввода:

| Команда / кнопка | Описание в меню |
|------------------|------------------|
| `/start` | Создать команду или войти по приглашению |
| `/schedule` — **Расписание** | Расписание игр |
| `/roster` — **Состав** | Состав команды |
| `/profile` — **Мой профиль** | Посмотреть свой профиль (имя, номер, долг) |
| `/leave` — **Выйти из команды** | Выйти из команды |
| `/poll` — **Опрос на игру** | Опрос на игру (вопрос и варианты по шагам) |
| `/invite` — **Приглашение** | Создать приглашение в команду (ссылка и QR) |

---

## 1. `/start`

**Триггеры:** команда `/start` или `/start КОД` (например из ссылки приглашения).

### 1.1 `/start` с кодом приглашения (`/start КОД`)

- **Поведение:** бот ищет приглашение по коду. Если найдено и не истекло — добавляет пользователя в команду с ролью из приглашения (PLAYER/ADMIN), обновляет @username и имя из профиля Telegram при наличии.
- **Успех:** сообщение «Вы добавлены в команду «…». Роль: … Дальше: откройте чат команды в Telegram и напишите там /start, чтобы видеть расписание и состав.»
- **Неудача (код не найден, истёк или уже использован):** «Приглашение недействительно или уже использовано.»
- **Примечание:** приглашение не удаляется после использования — по одной ссылке могут войти несколько человек.

### 1.2 `/start` без кода — чат уже привязан к команде

- **Поведение:** по `chatId` находится команда. Если участник деактивирован в админке — бот отвечает: «Вы деактивированы. Обратитесь к администратору команды.» (меню не показывается). Иначе бот приветствует и показывает меню кнопок.
- **Ответ (активный участник):** «Привет! Команда: «…». Расписание, состав, имя (Мой профиль), выход из команды, опрос — кнопки ниже.» + клавиатура (Расписание, Состав, Мой профиль, Выйти из команды, Опрос на игру, Приглашение).
- Дополнительно обновляется @username пользователя в записи участника, если он указан в Telegram.

### 1.3 `/start` без кода — чат не привязан к команде (создание команды)

- **Проверка доступа:** создавать команду может только пользователь, чей Telegram ID или @username совпадает с настройкой «Доступ в бот» в веб-админке (system setting `admin_telegram_username` или `admin_telegram_id`).
- **Если доступ есть:** бот ставит чат в режим ожидания названия команды и отвечает: «Привет! Отправь название команды одним сообщением. Например: БК Метеор».
- **Если доступа нет:** «Создать команду может только администратор. Попросите ссылку-приглашение у менеджера команды.»

### 1.4 Следующее сообщение после запроса названия команды

- **Если пользователь в состоянии «ожидание названия»:** текст считается названием команды.
  - **Не пустое:** создаётся команда с этим названием, чат привязывается к ней (`team.telegram_chat_id = chatId`), создатель добавляется как участник с ролью ADMIN. Ответ: «Команда «…» создана. Участники видят расписание, состав, могут посмотреть свой профиль (кнопка «Мой профиль») и выйти из команды. Редактирование — в админке.» + меню кнопок.
  - **Пустое или только пробелы:** «Название не может быть пустым. Отправь название команды.» Состояние ожидания названия сохраняется.

---

## 2. Расписание (будущие игры)

**Триггеры:** команда `/schedule` или кнопка **«Расписание»**.

- **Условие:** чат должен быть привязан к команде. Иначе бот отвечает: «Сначала создай команду: отправь /start и затем название команды.»
- **Поведение:** показываются **только будущие игры** (дата матча ≥ сейчас), сортировка по дате по возрастанию (ближайшие первые). Формат строки: статус (⏳ запланирован / ✅ завершён / ❌ отменён), дата и время (dd.MM.yyyy HH:mm), соперник, при завершённом матче — счёт, при наличии — место проведения.
- **Если будущих матчей нет:** «Ближайших игр нет. Расписание добавят в админке.»

## 2.1 Прошедшие игры

**Триггеры:** кнопка **«Прошедшие игры»** (команды в меню нет).

- **Условие:** чат привязан к команде.
- **Поведение:** показываются **только прошедшие игры** (дата матча &lt; сейчас), сортировка по дате по убыванию (последние первые). Формат тот же: статус, дата, соперник, счёт, место.
- **Если прошедших матчей нет:** «Прошедших игр пока нет.»

---

## 3. Состав команды

**Триггеры:** команда `/roster` или кнопка **«Состав»**.

- **Условие:** чат привязан к команде (иначе та же подсказка про /start и название).
- **Поведение:** вывод списка по одному игроку на каждого активного участника (TeamMember). Имя, номер и статус берутся из карточки игрока (Player) в админке при наличии; иначе показывается имя из участника. Дубликатов нет: в составе ровно столько строк, сколько активных участников команды.
- **Если состав пуст:** «Состав пуст. Участников добавляют через приглашения и админку.»

---

## 4. Мой профиль (только просмотр)

**Триггеры:** команда `/profile` или кнопка **«Мой профиль»**.

- **Условие:** чат привязан к команде.
- **Поведение:** бот показывает текущий профиль участника (как в админке, раздел Участники):
  - **Имя** — отображаемое имя (поле «Имя» в админке);
  - **Номер** — номер игрока (если задан в админке, иначе «—»);
  - **Долг** — текущий долг в рублях или «нет», если долга нет.


**Деактивированный участник:** в админке (Участники) можно деактивировать участника — он перестаёт отображаться в «Составе» и **не может пользоваться ботом**. На любую команду или кнопку бот отвечает: «Вы деактивированы. Обратитесь к администратору команды.»

---

## 5. Выйти из команды

**Триггеры:** команда `/leave` или кнопка **«Выйти из команды»**.

- **Условие:** чат привязан к команде.
- **Поведение:** бот переводит чат в режим подтверждения выхода. Ответ: «Выйти из команды? Напиши ДА для подтверждения.»
- **Следующее сообщение:**
  - **Текст «ДА» (без учёта регистра):** участник деактивируется (`TeamMember.isActive = false`). Ответ: «Вы вышли из команды. Чтобы снова вступить, нужна новая ссылка-приглашение от админа.»
  - **Любой другой текст:** «Выход отменён. Напиши ДА, если точно хочешь выйти из команды.» Состояние ожидания подтверждения сохраняется.

---

## 6. Опрос на игру

**Триггеры:** кнопка **«Опрос на игру»** или команда `/poll` (без ввода `/poll` в чат — всё по шагам).

- **Условие:** чат привязан к команде (иначе подсказка про создание команды).
- **Шаг 1 — вопрос:** при нажатии кнопки или отправке `/poll` бот просит: «Напиши вопрос для опроса одним сообщением. Например: Кто едет на игру?» Пользователь отправляет вопрос текстом (без команды).
- **Шаг 2 — варианты ответа:** бот просит: «Напиши варианты ответа через запятую. Например: Еду, Не еду, Опоздаю». Пользователь отправляет варианты через запятую или с новой строки (минимум 2, до 10 вариантов).
- **Результат:** бот отправляет в чат нативный опрос Telegram с введённым вопросом и вариантами. Опрос всегда **не анонимный** (видно, кто как ответил). Вопрос обрезается до 255 символов, каждый вариант — до 100 символов.
- **Команда `/poll Текст вопроса`:** вопрос задаётся сразу, бот сразу просит варианты ответа (шаг 2).
- **Отмена:** если в шаге 2 прислано меньше 2 вариантов, бот сообщает об ошибке и сбрасывает состояние; можно начать заново с кнопки «Опрос на игру».

**Куда уходит опрос:** опрос отправляется в чат команды. Приоритет: 1) если в админке (Настройки) указан **ID группового чата** — опрос уходит туда; 2) иначе — в чат, к которому привязана команда (`telegram_chat_id`, то есть туда, где создавали команду по /start); 3) если чат не задан — в личку отправителя. Сообщение «Опрос отправлен в чат команды.» пользователь видит у себя. Если команда создана в личке, укажите в Настройках ID группового чата (например -100…), добавьте бота в группу — опросы и уведомления пойдут в эту группу.

---

## 6.1 Приглашение в команду (/invite)

**Триггеры:** команда `/invite` или кнопка **«Приглашение»**.

- **Условие:** чат привязан к команде. Выполнять может только **администратор** команды (роль ADMIN в веб-админке или создатель команды).
- **Поведение:** бот создаёт новое приглашение (роль: Игрок, срок: 7 дней), формирует ссылку вида `t.me/BotUsername?start=CODE` и отправляет в чат:
  1. Текстовое сообщение с текстом приглашения и ссылкой (её можно переслать новым участникам).
  2. Фото с **QR-кодом**, кодирующим эту ссылку (можно отсканировать для перехода в бота).
- **Если пользователь не админ:** «Создавать приглашения может только администратор команды.»
- Приглашения также можно создавать и просматривать в веб-админке (страница «Приглашения»).

---

## 7. Произвольный текст (не команда и не кнопка)

- **Если чат привязан к команде:** ответ с клавиатурой: «Используй кнопки меню или команды: Расписание, Состав, Мой профиль, Выйти из команды, Опрос на игру, Приглашение.»
- **Если чат не привязан и пользователь не в режиме «ожидание названия»:** «Сначала создай команду: отправь /start и затем название команды.»

---

## 8. Callback-запросы (inline-кнопки)

При нажатии на inline-кнопку бот получает `CallbackQuery`. Сейчас на любой такой запрос отправляется ответ: «Команда недоступна. Управление — в админке.» (alert). В боте нет сценариев с inline-кнопками; управление — в веб-админке.

---

## Кнопки меню (Reply-клавиатура)

После входа в команду (или создания) отображается постоянная клавиатура:

| Ряд 1 | Расписание | Прошедшие игры |
| Ряд 2 | Состав |
| Ряд 3 | Мой профиль | Выйти из команды | Опрос на игру |
| Ряд 4 | Приглашение |

Нажатие на кнопку эквивалентно отправке текста кнопки (обрабатывается так же, как соответствующая команда).

---

## Порядок обработки сообщения

1. **CallbackQuery** — отдельно, ответ «Команда недоступна…».
2. **Режим «ожидание названия команды»** — текст трактуется как название (создание команды или ошибка «пустое»).
3. **`/start` или `/start …`** — разбор по коду/привязке чата (приглашение, приветствие, запрос названия или отказ).
4. **Режим «ожидание подтверждения выхода»** — текст ДА/не ДА.
5. **Режим «создание опроса»** — если чат в состоянии опроса (ждём вопрос или варианты), текст трактуется как вопрос или варианты ответа.
6. **Поиск команды по chatId** — если команды нет, подсказка «сначала создай команду».
7. **Обновление @username** участника при наличии.
8. **Расписание / Прошедшие игры / Состав / Мой профиль / Выйти / Опрос / Приглашение** — по триггеру (команда или кнопка).
9. **Любой другой текст** — подсказка про кнопки и команды.

При любом исключении в обработке пользователю отправляется: «Ошибка: » + сообщение исключения.

---

Связанные документы: [BOT_SCENARIOS.md](BOT_SCENARIOS.md), [SMOKE_TESTS_TELEGRAM.md](SMOKE_TESTS_TELEGRAM.md), [VERIFICATION.md](VERIFICATION.md).
