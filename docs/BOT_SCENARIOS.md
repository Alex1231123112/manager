# Сценарии работы бота «Цифровой менеджер»

Один чат = одна команда. Все данные привязаны к `team_id`, который определяется по `telegram_chat_id` чата.

**Все команды доступны через кнопки:** основные действия — Reply-кнопки (Состав, Добавить игрока, Новый матч, Ввести результат, Опрос на игру, Долги, Команды). Кнопка **«Команды»** открывает Inline-меню с фильтрами состава (все, активные, травма, отпуск, не оплатил) и подсказками для «Изменить статус», «Настроить канал», «Выставить долг». Публикация в канал — Inline-кнопка после ввода результата. Список команд (при нажатии «/» в чате) зарегистрирован в Telegram и совпадает с этими действиями.

---

## 1. Первый запуск и создание команды

**Ограничение:** создать новую команду по `/start` (без кода приглашения) может **только администратор** — пользователь, чей Telegram ID указан в веб-админке в настройках «Telegram ID администратора». Если этот ID не задан или не совпадает с отправителем, бот не предлагает ввести название команды, а просит получить приглашение.

| Шаг | Действие пользователя | Ответ бота |
|-----|------------------------|------------|
| 1 | Отправляет `/start` (без кода) и его Telegram ID **совпадает** с настройкой в админке | «Привет! Отправь название команды одним сообщением. Например: БК Метеор» |
| 1 | Отправляет `/start` (без кода), его Telegram ID **не совпадает** или настройка не задана | «Создать команду может только администратор. Попросите ссылку-приглашение у менеджера команды.» |
| 2 | Отправляет любое сообщение (название команды) | Если не пусто — команда создаётся, привязывается к чату, показывается меню с кнопками. Текст: «Команда «…» создана. Добавляй игроков и матчи.» |
| 2 (пусто) | Отправляет пустое или только пробелы | «Название не может быть пустым. Отправь название команды.» — бот снова ждёт название |

**Повторный `/start` (команда уже есть):**  
«Привет! Команда: «…». Что делаем?» + меню.

**Команда не создана, пользователь пишет что-то кроме `/start`:**  
«Сначала создай команду: отправь /start и затем название команды.»

---

## 1.1 Приглашения в команду

Новый участник может войти в **существующую** команду по одноразовой ссылке-приглашению (или по коду в `/start CODE`). Создавать приглашения могут капитан и админ (в боте — кнопка **Приглашение** или `/invite`, в веб-админке — страница «Приглашения»).

| Действие | Результат |
|----------|-----------|
| Капитан/админ: кнопка **Приглашение** или `/invite` | Бот создаёт приглашение (роль по умолчанию PLAYER, срок 7 дней), отправляет в чат **QR-код** и **ссылку** вида `https://t.me/BotUsername?start=CODE`. |
| Капитан/админ: `/invite PLAYER` или `/invite CAPTAIN` | То же, но роль приглашаемого — указанная (PLAYER, CAPTAIN или ADMIN). |
| Новый пользователь переходит по ссылке или вводит в боте `/start CODE` | Бот добавляет его в команду с указанной в приглашении ролью и удаляет приглашение. Сообщение: «Вы добавлены в команду «…». Роль: … Если бот в чате команды, напиши там /start.» |
| `/start CODE` с недействительным или уже использованным кодом | «Приглашение недействительно или уже использовано.» |

В веб-админке на странице «Приглашения» отображаются все приглашения команды: код, ссылка (копирование), роль, срок действия, QR-код; можно создавать новые (роль, срок в днях) и удалять.

---

## 2. Состав команды

### 2.1 Просмотр состава

| Действие | Результат |
|----------|-----------|
| Кнопка **Состав** или `/roster` | Список всех игроков: имя, номер, статус (активен / травма / отпуск / не оплатил). Внизу подсказка по фильтрам и `/setstatus`. |
| Состав пустой | «Состав пуст. Добавь игроков: кнопка «Добавить игрока» или /addplayer Имя Номер.» |

### 2.2 Фильтр по статусу

| Действие | Результат |
|----------|-----------|
| `/roster активные` (или `активен`, `активный`) | Только игроки со статусом «активен» |
| `/roster травма` | Только со статусом «травма» |
| `/roster отпуск` | Только «отпуск» |
| `/roster не оплатил` (или `неоплатил`) | Только «не оплатил» |
| `/roster что-то-другое` | Показывается полный состав (фильтр не распознан) |

Если по выбранному фильтру никого нет:  
«Нет игроков со статусом «…».»

### 2.3 Добавление игрока

| Действие | Результат |
|----------|-----------|
| Кнопка **Добавить игрока** или `/addplayer` | Подсказка: «Добавление игрока. Напиши: Имя Номер. Например: Иван Петров 23» |
| `/addplayer Иван Петров 23` | Игрок добавлен: «Игрок Иван Петров №23 добавлен.» |
| `/addplayer Иван` (без номера) или только номер | «Формат: Имя Номер. Например: Иван Петров 23» |
| Номер не число | «Номер должен быть числом. Например: Иван Петров 23» |
| Пустое имя или отрицательный номер | Сообщение об ошибке от сервиса (валидация) |

### 2.4 Изменение статуса игрока

| Действие | Результат |
|----------|-----------|
| `/setstatus Иван Петров травма` | «Статус обновлён: Иван Петров — травма.» |
| `/setstatus Иван не оплатил` | Статус «не оплатил» (два слова поддерживаются) |
| `/setstatus Имя` (без статуса) или неизвестный статус | Подсказка по формату или «Неизвестный статус. Укажи: активен, травма, отпуск или не оплатил.» |
| Игрок не найден (неточное имя) | «Игрок не найден: …» |

---

## 3. Матчи и результаты

### 3.1 Создание матча

| Действие | Результат |
|----------|-----------|
| Кнопка **Новый матч** или `/newmatch` | «Создание матча. Напиши: /newmatch Соперник. Например: /newmatch ЦСКА» |
| `/newmatch ЦСКА` | Матч создаётся с датой «сейчас», статус «запланирован». «Матч создан: ДД.ММ.ГГГГ против ЦСКА. Ввести счёт: /result наши их» |
| `/newmatch` (без соперника) | «Укажи соперника: /newmatch Соперник» |

Создаётся один запланированный матч; для ввода результата всегда берётся **последний** запланированный по дате.

### 3.2 Подсказка по вводу результата

| Действие | Результат |
|----------|-----------|
| Кнопка **Ввести результат** или `/result` (без чисел) | Если есть запланированный матч: «Последний матч: против …. Введи счёт: /result наши их. Например: /result 85 82». Если матчей нет: «Нет запланированных матчей. Создай матч: /newmatch Соперник» |

### 3.3 Ввод результата

| Действие | Результат |
|----------|-----------|
| `/result 85 82` | Результат сохраняется за последний запланированный матч, матч переводится в «завершён». Бот отправляет: 1) «Результат сохранён: 85 : 82 (против …)» 2) Текст поста для соцсетей (если шаблон даёт непустой текст) 3) Картинку 1080×1080 4) Сообщение «Карточка готова. Опубликовать в канал?» с inline-кнопкой **Опубликовать в канал** |
| `/result 85` или `/result 85 82 1` | «Формат: /result наши очки очки соперника. Например: /result 85 82» |
| `/result абв 82` | «Оба значения должны быть числами. Например: /result 85 82» |
| Нет запланированного матча | «Нет запланированного матча для ввода результата.» |

---

## 4. Публикация в канал

### 4.1 Настройка канала

| Действие | Результат |
|----------|-----------|
| `/setchannel -1001234567890` | «Канал для публикации задан. После ввода результата можно нажать «Опубликовать в канал».» |
| `/setchannel` (без ID) | «Формат: /setchannel ID_канала. ID канала обычно вида -1001234567890. Добавь бота в канал как админа.» |

### 4.2 Кнопка «Опубликовать в канал»

Появляется после ввода результата (см. п. 3.3).

| Действие | Результат |
|----------|-----------|
| Нажатие кнопки **Опубликовать в канал** | Бот проверяет: 1) команда по чату найдена 2) у команды задан канал 3) матч по ID и команде найден. Затем генерирует картинку и отправляет её **в канал** (по сохранённому ID). Пользователю: всплывающее уведомление «Опубликовано в канал.» |
| Канал не задан | Всплывающее предупреждение: «Сначала укажи канал: /setchannel ID_канала» |
| Матч не найден / ошибка данных | Сообщения об ошибке во всплывающем уведомлении |
| Пользователь без прав (не админ/капитан) нажимает «Опубликовать в канал» | Всплывающее уведомление: «Только админ или капитан может выполнить это действие.» |

---

## 4.3 Роли и права

Один чат = одна команда. Участники чата имеют роли: **ADMIN** (создатель команды), **CAPTAIN**, **PLAYER**. Опасные действия (добавление игрока, новый матч, ввод результата, долги, канал, публикация в канал, смена статуса) доступны только **админу или капитану**. Назначать роли может только **админ**.

| Действие | Результат |
|----------|-----------|
| Создание команды (первый /start + название) | Отправитель сообщения становится **ADMIN** этой команды. |
| `/setrole 123456789 CAPTAIN` | Админ назначает пользователю с Telegram ID 123456789 роль CAPTAIN. Ответ: «Роль назначена: 123456789 — CAPTAIN». |
| `/setrole 123456789 PLAYER` | Понижение до игрока (только админ). |
| `/setrole` (без аргументов или неверный формат) | Подсказка: «Формат: /setrole TelegramID роль. Роли: ADMIN, CAPTAIN, PLAYER. Пример: /setrole 123456789 CAPTAIN». |
| Не админ вызывает /setrole | «Только админ или капитан может выполнить это действие.» (для setrole требуется именно админ). |
| Игрок (PLAYER) вызывает /setdebt, /paid, /addplayer, /newmatch, /result, /setchannel, /setstatus или нажимает «Оплатил» / «Опубликовать в канал» | «Только админ или капитан может выполнить это действие.» |

Команды без записей в ролях (созданные до введения ролей) считают любого пользователя админом.

---

## 5. Опросы на игру

| Действие | Результат |
|----------|-----------|
| Кнопка **Опрос на игру** или `/poll` | «Опрос на игру. Напиши: /poll Текст вопроса. Например: /poll Кто едет в субботу?» |
| `/poll Кто едет в субботу?` | В чат отправляется опрос с вопросом «Кто едет в субботу?» и вариантами: **Еду**, **Не еду**, **Опоздаю**. |
| `/poll` (без текста или пустой текст) | Вопрос по умолчанию: «Кто едет на игру?» |
| Текст длиннее 255 символов | Обрезается до 255 символов |

---

## 6. Долги

### 6.1 Просмотр долгов

| Действие | Результат |
|----------|-----------|
| Кнопка **Долги** или `/debt` | Если есть должники: список «• Имя — сумма ₽», подсказка по /paid и /setdebt, под каждым должником — Inline-кнопка **Оплатил: Имя**. Если долгов нет: «Долгов нет.» |

### 6.2 Выставление долга

| Действие | Результат |
|----------|-----------|
| `/setdebt Иван Петров 500` | «Долг для Иван Петров: 500 ₽.» (поиск игрока по имени, точное или вхождение подстроки) |
| `/setdebt Иван 500` | Аналогично |
| Меньше двух слов или сумма не число | Подсказка по формату или «Сумма должна быть числом. Например: /setdebt Иван 500» |
| Игрок не найден | «Игрок не найден: …» |

Сумма: число, запятая или точка как десятичный разделитель.

### 6.3 Отметка об оплате

| Действие | Результат |
|----------|------------|
| `/paid Иван Петров` | Долг игрока сбрасывается в 0. Ответ: «Оплата отмечена: Иван Петров.» |
| `/paid` (без имени) | «Формат: /paid Имя. Например: /paid Иван Петров» |
| Игрок не найден | Сообщение об ошибке |
| Нажатие Inline-кнопки **Оплатил: Имя** в списке долгов | Долг снимается, уведомление «Долг снят: Имя», бот присылает обновлённый список долгов (или «Долгов нет.») |

---

## 7. Автоматические напоминания (планировщик)

Работают в фоне, без действий пользователя. Чат команды определяется по `telegram_chat_id` (чат, в котором создана команда).

| Когда | Что происходит |
|-------|-----------------|
| За **24 часа** до времени матча (окно ~2 ч) | В чат команды отправляется **опрос** «Через сутки матч с «Соперник» (ДД.ММ ЧЧ:ММ). Кто едет?» с вариантами Еду / Не еду / Опоздаю. Флаг «напоминание 24 ч отправлено» ставится, повторно не шлётся. |
| За **~3 часа** до матча (окно ~1 ч) | В чат отправляется текст: «Через ~3 часа матч с «Соперник» (ДД.ММ ЧЧ:ММ). Удачи!» Флаг «напоминание 3 ч» ставится. |
| **После матча** (0.5–25 ч после времени матча) | В чат: «Матч с «Соперник» прошёл. Введите результат и статистику: /result». Флаг «напоминание после матча» ставится. |

Учитываются только матчи со статусом **запланирован** (SCHEDULED). После ввода результата матч переводится в «завершён», напоминания по нему больше не отправляются.

---

## 8. Прочие сценарии

| Ситуация | Поведение |
|----------|-----------|
| Текст сообщения не распознан как команда | «Неизвестная команда. Используй кнопки меню или /start.» |
| Любая ошибка при обработке (например, БД) | «Ошибка: …» (текст исключения). |
| Сообщение без текста (фото, стикер и т.д.) | Игнорируется. |
| Callback от неизвестной кнопки (не `publish:…`, не `paid:…`, не `roster:…`, не `cmd:…`) | Ничего не делается. |

---

## 9. Сводка: все команды через Reply- или Inline-кнопки

**Reply-кнопки (главное меню):** Состав, Добавить игрока, Новый матч, Ввести результат, Опрос на игру, Долги, **Команды**, **Приглашение**.

**Кнопка «Команды»** открывает Inline-меню:
- **Состав (все)**, **Активные**, **Травма**, **Отпуск**, **Не оплатил** — состав сразу с нужным фильтром;
- **Изменить статус**, **Настроить канал**, **Выставить долг** — бот присылает подсказку с форматом команды.

**Список команд бота** (при нажатии «/» в чате) регистрируется в Telegram и совпадает с кнопками.

| Ввод | Действие |
|------|----------|
| `/start` | Создание команды или приветствие + меню |
| **Состав** / `/roster` | Состав (все) |
| **Команды** / `/commands` | Inline-меню: фильтры состава, статус, канал, долг |
| Inline: **Состав (все)** и т.д. | Состав с выбранным фильтром |
| Inline: **Изменить статус** и т.д. | Подсказка с форматом команды |
| `/roster активные \| травма \| отпуск \| не оплатил` | Состав с фильтром (дублирует Inline) |
| **Добавить игрока** / `/addplayer` | Подсказка по добавлению |
| `/addplayer Имя Номер` | Добавить игрока |
| `/setstatus Имя статус` | Изменить статус игрока |
| **Новый матч** / `/newmatch` | Подсказка по матчу |
| `/newmatch Соперник` | Создать матч |
| **Ввести результат** / `/result` | Подсказка по результату |
| `/result наши их` | Ввести счёт, пост, картинка, кнопка публикации |
| **Опрос на игру** / `/poll` | Подсказка по опросу |
| `/poll Текст` | Отправить опрос в чат |
| **Долги** / `/debt` | Список долгов (с кнопками «Оплатил: Имя») |
| `/setdebt Имя Сумма` | Выставить долг |
| `/paid Имя` | Отметить оплату (сброс долга) |
| Inline **Оплатил: Имя** в списке долгов | Снять долг с игрока |
| `/setchannel ID_канала` | Привязать канал для публикации |
| Inline-кнопка **Опубликовать в канал** | Отправить картинку результата в канал |
| `/setrole TelegramID ADMIN\|CAPTAIN\|PLAYER` | Назначить роль участнику (только админ) |
| **Приглашение** / `/invite` или `/invite PLAYER\|CAPTAIN\|ADMIN` | Создать приглашение в команду (капитан/админ): бот присылает QR и ссылку |
| `/start CODE` (переход по ссылке приглашения) | Добавить себя в команду по приглашению; код одноразовый |

Все сценарии предполагают, что команда уже создана (чат привязан к команде). Иначе бот отвечает: «Сначала создай команду: отправь /start и затем название команды.» (либо просит использовать приглашение, если пользователь не системный администратор).
