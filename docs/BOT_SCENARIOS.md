# Сценарии работы бота «Цифровой менеджер»

Один чат = одна команда. Все данные привязаны к `team_id`, который определяется по `telegram_chat_id` чата.

**В боте** участники видят: расписание игр, состав команды, свой профиль (имя), выход из команды, опрос на игру. **Управление** (добавление игроков, матчи, результаты, долги, приглашения, настройки) выполняется в **веб-админке**.

Справочник по всем командам и кнопкам: [BOT_COMMANDS.md](BOT_COMMANDS.md).

---

## 1. Первый запуск и создание команды

**Первичная настройка — в админке.** Если в веб-админке ещё нет ни одной команды, при входе показывается экран **«Первоначальная настройка»**: нужно указать **Telegram @username** того, кто сможет создать первую команду в боте. После сохранения этот пользователь открывает бота в Telegram и создаёт команду.

**В боте:** создать новую команду по `/start` (без кода приглашения) может только пользователь, чей **Telegram @username** (или Telegram ID) совпадает с настройкой «Доступ в бот» в веб-админке. Если настройка не задана или не совпадает с отправителем, бот просит получить приглашение у менеджера команды.

| Шаг | Действие пользователя | Ответ бота |
|-----|------------------------|------------|
| 0 | В веб-админке (когда команд ещё нет): указать Telegram @username и нажать «Сохранить» | Сохранено. Этот пользователь может в боте отправить /start и создать первую команду. |
| 1 | Отправить `/start` (без кода), его @username/ID **совпадает** с настройкой в админке | «Привет! Отправь название команды одним сообщением. Например: БК Метеор» |
| 1 | Отправить `/start` (без кода), его @username/ID **не совпадает** или настройка не задана | «Создать команду может только администратор. Попросите ссылку-приглашение у менеджера команды.» |
| 2 | Отправить название команды (не пустое) | Команда создаётся, привязывается к чату. «Команда «…» создана. Участники видят расписание, состав, могут посмотреть свой профиль (кнопка «Мой профиль») и выйти из команды. Редактирование — в админке.» + меню кнопок. |
| 2 (пусто) | Отправить пустое или только пробелы | «Название не может быть пустым. Отправь название команды.» |

**Повторный `/start` (команда уже есть):**  
«Привет! Команда: «…». Расписание, состав, имя (Мой профиль), выход из команды, опрос — кнопки ниже.» + меню.

**Команда не создана, пользователь пишет что-то кроме `/start`:**  
«Сначала создай команду: отправь /start и затем название команды.»

---

## 1.1 Приглашения в команду

Приглашения **создаются в веб-админке** (страница «Приглашения»): код, ссылка, роль (Игрок или Админ), срок действия. В боте участник только **входит по приглашению**.

| Действие | Результат |
|----------|-----------|
| Новый пользователь переходит по ссылке или вводит в боте `/start CODE` | Бот добавляет его в команду с указанной в приглашении ролью и удаляет приглашение. «Вы добавлены в команду «…». Роль: … Если бот в чате команды, напиши там /start.» |
| `/start CODE` с недействительным или уже использованным кодом | «Приглашение недействительно или уже использовано.» |

В веб-админке на странице «Приглашения» отображаются все приглашения команды (код, ссылка, роль, срок), можно создавать новые и удалять.

---

## 2. Роли в боте

Роли только две: **Игрок (PLAYER)** и **Админ (ADMIN)**. В боте все участники видят одно и то же меню (расписание, состав, профиль, выход, опрос). Различие ролей используется в веб-админке (кто может управлять командой) и для уведомлений. Создатель команды получает роль ADMIN.

Назначать и менять роли можно в веб-админке на странице «Участники».

---

## 3. Расписание и прошедшие игры

| Действие | Результат |
|----------|-----------|
| Кнопка **Расписание** или `/schedule` | Только **будущие игры** (дата ≥ сейчас), ближайшие первые. Формат: дата, соперник, статус, при наличии — счёт и место. |
| Кнопка **Прошедшие игры** | Только **прошедшие игры** (дата < сейчас), последние первые. Тот же формат. |
| Будущих матчей нет | «Ближайших игр нет. Расписание добавят в админке.» |
| Прошедших матчей нет | «Прошедших игр пока нет.» |

Матчи добавляются и редактируются в веб-админке (раздел «Матчи»).

---

## 4. Состав команды

| Действие | Результат |
|----------|-----------|
| Кнопка **Состав** или `/roster` | Список игроков: имя, номер, статус (активен / травма / отпуск / не оплатил). |
| Состав пустой | «Состав пуст. Участников добавляют через приглашения и админку.» |

Игроков добавляют через приглашения и веб-админку; редактирование (номер, статус) — в админке. Деактивированный в админке участник не показывается в «Составе» и не может пользоваться ботом: на любую команду бот отвечает «Вы деактивированы. Обратитесь к администратору команды.»

---

## 5. Мой профиль и выход из команды

### 5.1 Мой профиль (только просмотр)

| Действие | Результат |
|----------|-----------|
| Кнопка **Мой профиль** или `/profile` | Бот показывает профиль: Имя, Номер, Долг (как в админке). Подсказка: редактирование — в админке (Участники). |

### 5.2 Выход из команды

| Действие | Результат |
|----------|-----------|
| Кнопка **Выйти из команды** или `/leave` | Бот просит подтвердить выход (например, повторно нажать кнопку или подтвердить). |
| Подтверждение | «Вы вышли из команды. Чтобы снова вступить, нужна новая ссылка-приглашение от админа.» Участник удаляется из команды. |

---

## 6. Опрос на игру (по шагам, без команды в чате)

| Действие | Результат |
|----------|-----------|
| Кнопка **Опрос на игру** или **/poll** | Бот просит написать вопрос одним сообщением. |
| Пользователь отправляет вопрос текстом | Бот просит написать варианты ответа через запятую. |
| Пользователь отправляет варианты (например: Еду, Не еду, Опоздаю) | Опрос отправляется **в чат команды** (группу, где есть бот / к которой привязана команда), не анонимный. |
| **/poll Текст вопроса** | Вопрос задаётся сразу, бот сразу просит варианты ответа. |
| Меньше 2 вариантов | Бот сообщает об ошибке; можно начать заново с кнопки. |

Опрос уходит в чат команды. Если в админке (Настройки) указан ID группового чата — опрос и уведомления идут туда; иначе используется чат, к которому привязана команда (где создавали по /start). Если команда создана в личке — укажите в Настройках ID группы и добавьте бота в группу.

---

## 7. Управление в веб-админке

В боте **нет** кнопок и команд для добавления игроков, создания матчей, ввода результата, долгов, настройки канала, публикации в канал, создания приглашений. Всё это делается в **веб-админке**:

- **Дашборд** — сводка, уведомление команде.
- **Матчи** — создание и редактирование матчей, ввод результата.
- **Долги** — просмотр и выставление долгов, отметка об оплате.
- **Участники** — список участников команды (Telegram, имя, роль), смена ролей (Игрок/Админ).
- **Приглашения** — создание ссылок-приглашений (роль, срок), QR и копирование ссылки.
- **Настройки** — канал для публикации, доступ в бот (Telegram @username администратора).

Админ может отправить **уведомление команде** — текст уйдёт в чат команды в Telegram.

---

## 8. Автоматические напоминания (планировщик)

Работают в фоне. Чат команды определяется по `telegram_chat_id`.

| Когда | Что происходит |
|-------|-----------------|
| За **24 часа** до времени матча | В чат команды отправляется опрос «Кто едет?» (Еду / Не еду / Опоздаю). |
| За **~3 часа** до матча | Напоминание о матче. |
| **После матча** | Напоминание ввести результат (в админке). |

Учитываются только матчи со статусом «запланирован».

---

## 9. Прочие сценарии

| Ситуация | Поведение |
|----------|-----------|
| Текст сообщения не распознан как команда | Подсказка про кнопки меню и опрос («Опрос на игру»). |
| Нажатие на Inline-кнопку (если когда-то появятся) | «Команда недоступна. Управление — в админке.» |
| Любая ошибка при обработке | «Ошибка: …» |
| Сообщение без текста (фото, стикер и т.д.) | Игнорируется. |

---

## 10. Сводка: команды и кнопки бота

**Reply-кнопки (меню):** Расписание, Прошедшие игры, Состав, Мой профиль, Выйти из команды, Опрос на игру.

**Команды (при нажатии «/» в чате):**

| Ввод | Действие |
|------|----------|
| `/start` | Создание команды (если разрешено) или приветствие + меню |
| `/start CODE` | Вход по приглашению |
| **Расписание** / `/schedule` | Показать будущие игры |
| **Прошедшие игры** | Показать прошедшие игры |
| **Состав** / `/roster` | Показать состав команды |
| **Мой профиль** / `/profile` | Показать имя, номер, долг (редактирование — в админке) |
| **Выйти из команды** / `/leave` | Подтвердить выход из команды |
| **Опрос на игру** / `/poll` | По шагам: вопрос → варианты ответа через запятую → опрос в чат |

Все сценарии предполагают, что команда уже создана (чат привязан к команде). Иначе бот отвечает: «Сначала создай команду: отправь /start и затем название команды.» (либо просит приглашение, если пользователь не указан как администратор в настройках админки).
