services:
  postgres:
    image: postgres:16-alpine
    container_name: basketbot-postgres
    environment:
      POSTGRES_DB: basketbot
      POSTGRES_USER: basketbot
      POSTGRES_PASSWORD: basketbot
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U basketbot -d basketbot"]
      interval: 5s
      timeout: 5s
      retries: 5

  app:
    build: .
    container_name: basketbot-app
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 25s
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/basketbot
      SPRING_DATASOURCE_USERNAME: basketbot
      SPRING_DATASOURCE_PASSWORD: basketbot
      # ADMIN_* не задаём — Spring берёт дефолты из application.yml (admin/admin). Для своего пароля: в .env задать ADMIN_PASSWORD=... и добавить сюда ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_BOT_USERNAME: ${TELEGRAM_BOT_USERNAME:-BasketBot}
    ports:
      - "8095:8080"   # API и Thymeleaf-админка: http://localhost:8095/admin

  admin-ui:
    build:
      context: ./admin-ui
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ""
    container_name: basketbot-admin-ui
    restart: unless-stopped
    environment:
      API_BACKEND_URL: http://app:8080
    ports:
      - "3000:3000"
    depends_on:
      app:
        condition: service_healthy
    # Фронт вызывает /api/... (тот же origin), Next.js проксирует на app:8080
    # После доработок фронта пересобрать образ: docker compose build admin-ui && docker compose up -d admin-ui

  # Запуск автотестов (H2 in-memory, без Postgres): docker compose run --rm tests
  tests:
    image: maven:3.9-eclipse-temurin-17-alpine
    container_name: basketbot-tests
    working_dir: /project
    volumes:
      - .:/project
    command: mvn test -B

volumes:
  postgres_data:
